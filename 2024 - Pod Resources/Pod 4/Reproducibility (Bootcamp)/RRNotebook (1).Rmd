---
title: "R Notebook"
author: "Amanda Gahlot"
date: "2024_10_05"
output:
  html_document:
    toc: true
    toc_float: true
  pdf_document:
    toc: true
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

# 1. Set Up

This section reviews how to set up your Notebook. We will review headings for the table of contents, how to print code and/or output, and knit options.

## 1.1 Headings

Headings are created using hashtags and a space between the hastags and the words. 

## 1.2 Formatting

You can format text using Markdown:
- *Italics*: Use single asterisks `*italic text*` or underscores `_italic text_`.
- **Bold**: Use double asterisks `**bold text**` or underscores `__bold text__`.
- ***Bold Italics***: Use triple asterisks `***bold italic text***`.
- > **Blockquotes**: Use `>` before text to create an indented block.

To insert a **horizontal line** (separator), use three or more dashes `---` or asterisks `***`.

## 1.3 Knit Options

In R Markdown, you can customize how each code chunk behaves using chunk options. These options control whether the code, results, or any messages or warnings are displayed. Here are some commonly used chunk options:

***echo***: Controls whether the code itself is displayed in the output.

echo=TRUE (default): Show the code.
echo=FALSE: Hide the code but show the output.

***include***: Controls whether the code and the results are included in the output.

include=TRUE (default): Include both code and results.
include=FALSE: Exclude both code and results (useful for running code without showing it).

***results***: Controls how the output is displayed.

results='markup' (default): Show the usual output.
results='asis': Interpret the output as raw Markdown/HTML (useful for creating tables).
results='hide': Hide the results, but still execute the code.

***message and warning***: Controls whether messages and warnings generated by the code are displayed.

message=TRUE (default): Show messages.
message=FALSE: Hide messages.
warning=TRUE (default): Show warnings.
warning=FALSE: Hide warnings.

***fig.show***: Controls whether figures generated by the code chunk are displayed.

fig.show='asis': Shows figures inline.
fig.show='hide': Suppresses figure output.
fig.height and fig.width: Set the height and width of the figures generated by the chunk.

---
**So as an example:** 
{r knit option 1, echo=FALSE, include=TRUE, results='asis'} would exclude the actual code but would include the output with the results as they should be (great for visuals and tables). 


You can set a default of options for your entire notebook so you don't have to type it in each time. If you want to deviate from that setting, you just type in the extra options. 

```{r prelims}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
#now no error or warning messages will show when I knit this document. Note that I did not need to enter echo=TRUE or results=TRUE because those are already default settings. 
```

If i wanted a chunk of code to not knit either results or code, I could change it in the {r} section: {r, echo=FALSE, results=FALSE}

***PRO TIP***
When you try to knit something and get this error:

*Error in parse_block(g[-1], g[1], params.src, markdown_mode) : 
  Duplicate chunk label 'set wd', which has been used for the chunk:
setwd("/Users/amandagahlot/Documents/Dissertation/R_Output")
Calls: <Anonymous> ... process_file -> split_file -> lapply -> FUN -> parse_block
Execution halted*

This is because you need to have a unique name for each of your code blocks: {r something unique} 

# 2. Import data

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.


```{r chunk code}
#you can load all of your libraries with one click. 

#libraries
library(tidyverse)
library(psych)
library(data.table)
library(sjPlot) 
library(sjmisc) 
library(sjlabelled) 
library(gtsummary)
library(readxl)
```

Set your working directory (save time, save sanity)

```{r set wd, echo=FALSE}
setwd("/Users/amandagahlot/test")
```

Then import your data
 
```{r import data, results='hide'}

df <- read_excel('cleaned_data_Final.xlsx')

print(head(df))
```

# 3. Data cleaning

As an example, I want to rename some of my variables to define what they mean. For example, instead of "work_current" being 1 or 0, it will now be Yes or No. Because I only want to do this to create a demographics table, I don't want to mess with my original data frame. That would make some columns character instead of numeric or factor, which will mess me up later.

So, I create a new data frame called df_demo and change it there, keeping my original data frame intact.

```{r rename}
df_demo <- df
# level naming for categorical variables
df_demo$gender <- factor(df_demo$gender,
                   levels = c(1,2,3),
                   labels = c("Male", "Female", "Nonbinary"))

df_demo$work_current <- factor(df_demo$work_current,
                   levels = c(1,0),
                   labels = c("Yes", "No"))

df_demo$severity <- factor(df_demo$severity,
                   levels = c(2,3),
                   labels = c("Moderate", "Severe"))

df_demo$mech_injury <- factor(df_demo$mech_injury,
                   levels = c(1,2,3,4,5),
                   labels = c("Fall", "MVC", "Sports", "Violence", "Pedestrian struck"))

df_demo$income <- factor(df_demo$income,
                   levels = c(1,2,3),
                   labels = c("<52K", "52K-156K", ">156K"))

df_demo$marital_status <- factor(df_demo$marital_status,
                                 levels = c(1, 2, 3, 4),
                                 labels = c("Single", "Married", "Divorced", "Widowed"))

```
 
Now I have two data frames, the original "df" which is still numeric and df_demo which is character

# 4. Data analysis and visualization

First, we create a table of demographic characteristics with the mean (sd) or N(%) 

```{r demo total,  results='asis'}
demo_table <- df_demo %>%
  subset(., select = c(age_current, time_injury, gender, edu, race, work_current, income, house_size, marital_status, substance, severity, mech_injury)) %>%
  tbl_summary(
    missing = "no",
    type = list(
      c(age_current, edu, house_size, substance, time_injury) ~ "continuous",
      c(gender, income, work_current, severity, mech_injury) ~ "categorical"
    ),
    statistic = list(all_continuous() ~ "{mean} ({sd})", all_categorical() ~ "{n} ({p}%)"),
    label = list(
      age_current ~ "Age (years)",
      time_injury ~ "Time since TBI (years)",
      gender ~ "Gender",
      race ~ "Race/Ethnicity",
      edu ~ "Education (years)",
      work_current ~ "Employment status",
      income ~ "Annual household income",
      house_size ~ "Size household",
      marital_status ~ "Marital status",
      substance ~ "Substance use score",
      mech_injury ~ "Cause of injury",
      severity ~ "Severity of Injury"
    )
  ) %>%
  add_n()

print(demo_table)

```

What about visualizations? Next, we create a heat map correlation plot to examine the relationships between variables

```{r heatmap, results='asis'}
library(ggplot2)
library(reshape2)
library(Hmisc)

all_variables <- c("age_current", "time_injury", "gender", "edu", "work_current", "income", "severity", "substance", "acsg_retain", "acsi_retain",  "acsl_retain",  "acsf_retain", "acss_retain", "tbiqol_anxiety_tscore", "tbiqol_comm_tscore", "tbiqol_ue_tscore","tbiqol_depression_tscore", "tbiqol_fatigue_tscore", "tbiqol_genconcern_tscore", "frsbe_apathy", "frsbe_exec", "frsbe_disinhib", "frsbe_total")

all_variables <- intersect(all_variables, colnames(df))  # Ensure selected variables are in the dataframe

all_variables_df <- df[, all_variables]

cor_matrix <- rcorr(as.matrix(all_variables_df),type = "spearman")$r
cor_matrix[upper.tri(cor_matrix)] <- NA
p_matrix <- rcorr(as.matrix(all_variables_df),type = "spearman")$P
p_matrix[is.na(p_matrix)]=.0000001
p_matrix[upper.tri(p_matrix)] <- NA

# Melt the correlation matrix for ggplot
melted_cor <- melt(cor_matrix,na.rm = T)
melted_p = melt(p_matrix,na.rm = T)

melted_cor$p=melted_p$value
melted_cor$psig=""
melted_cor$psig[melted_cor$p<.05]="*"
melted_cor$psig[melted_cor$p<.01]="**"
melted_cor$psig[melted_cor$p<.001]="***"

# Create a heatmap using ggplot2
ggplot(melted_cor, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = round(value,2)), vjust = 1, size = 2) +  # Adjust size here
  geom_text(aes(label = psig), vjust = .25, size = 6) +  # Adjust size here
  scale_fill_gradient2(low = "purple", mid = "white", high = "orange", 
                       midpoint = 0, limit = c(-1,1), space = "Lab",
                       name = "Correlation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),  # Adjust size here
        axis.text.y = element_text(angle = 45, hjust = 1, size = 10),  # Adjust size here
        axis.title = element_text(size = 14),
        axis.ticks = element_line(size = 1)) +
  labs(caption = "<.05 = *, <.01 = **, <.001 = ***") +
  xlab("") +
  ylab("") +
  ggtitle("Correlation Matrix all variables")

```


When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

